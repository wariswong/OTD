<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>แผนที่และผลการประมวลผล</title>
  <!-- Bootstrap + ArcGIS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.29/"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background-image: linear-gradient(0deg, #690089, #7e468f);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .navbar-custom .nav-link,
    .navbar-custom .navbar-brand {
      color: white;
    }

    #viewDiv {
      height: 500px;
      width: 100%;
    }

    .table-hover tbody tr:hover {
      background-color: #dfd2e3;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom mb-4">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-geo-alt-fill"></i> GIS</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-house-door-fill"></i> หน้าแรก</a></li>
        </ul>
      </div>
    </div>
  </nav>

  
  <div class="container-fluid">
    <div class="row">
      <div class="col-10">
        <div class="d-flex justify-content-between mb-3">
          <a href="/" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> กลับ</a>
        </div>
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-light fw-bold">แผนที่การจำลอง</div>
          <div class="card-body p-0">
            <div id="viewDiv"></div>
          </div>
        </div>

        <div class="card shadow-sm mt-4">
          <div class="card-header bg-custom text-dark">
            <strong>ผลการวิเคราะห์ระบบไฟฟ้า</strong>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                  <tr>
                    <th>รายการ</th>
                    <th>หม้อแปลงกลุ่มที่ 1</th>
                    <th>หม้อแปลงกลุ่มที่ 2</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>โหลดหม้อแปลง</strong></td>
                    <td>{{ result.g1_load }} kW</td>
                    <td>{{ result.g2_load }} kW</td>
                  </tr>
                  <tr>
                    <td><strong>โหลดคาดการณ์อีก 4 ปี (เพิ่มปีละ 1%)</strong></td>
                    <td>{{ result.future_g1_load }} kW</td>
                    <td>{{ result.future_g2_load }} kW</td>
                  </tr>
                  <tr>
                    <td><strong>ขนาดหม้อแปลงที่แนะนำ</strong></td>
                    <td>{{ result.rating_g1 }} kVA</td>
                    <td>{{ result.rating_g2 }} kVA</td>
                  </tr>
                  <tr>
                    <td><strong>Line Loss</strong></td>
                    <td>{{ result.line_loss_g1_kW }} kW</td>
                    <td>{{ result.line_loss_g2_kW }} kW</td>
                  </tr>
                  <tr>
                    <td><strong>Transformer Loss (Core+Copper Loss)</strong></td>
                    <td>{{ result.tx_loss_g1_kW }} kW</td>
                    <td>{{ result.tx_loss_g2_kW }} kW</td>
                  </tr>
                  <tr>
                    <td><strong>Loss รวม</strong></td>
                    <td>{{ result.total_system_loss_g1 }} kW</td>
                    <td>{{ result.total_system_loss_g2 }} kW</td>
                  </tr>

                  <tr class="table-primary">
                    <td colspan="3"><strong>Load balancing before Process</strong></td>
                  </tr>
                  <tr class="table-primary">
                    <td colspan="3"><strong>Group 1 percent unbalance before : {{result.Group_1_percent_unbalance_before}} %</strong></td>
                  </tr>
                  <tr class="table-primary">
                    <td colspan="3"><strong>Group 2 percent unbalance before : {{result.Group_2_percent_unbalance_before}} %</strong></td>
                  </tr>
                  <tr>
                    <td>Phase A</td>
                    <td>{{ result.group1_load_balance_before.A }} kW</td>
                    <td>{{ result.group2_load_balance_before.A }} kW</td>
                  </tr>
                  <tr>
                    <td>Phase B</td>
                    <td>{{ result.group1_load_balance_before.B }} kW</td>
                    <td>{{ result.group2_load_balance_before.B }} kW</td>
                  </tr>
                  <tr>
                    <td>Phase C</td>
                    <td>{{ result.group1_load_balance_before.C }} kW</td>
                    <td>{{ result.group2_load_balance_before.C }} kW</td>
                  </tr>

                  <tr class="table-success">
                    <td colspan="3"><strong>Load balancing after Process</strong></td>
                  </tr>
                  <tr class="table-success">
                    <td colspan="3"><strong>Group 1 percent unbalance after : {{result.Group_1_percent_unbalance_after}} %</strong></td>
                  </tr>
                  <tr class="table-success">
                    <td colspan="3"><strong>Group 2 percent unbalance after : {{result.Group_2_percent_unbalance_after}} %</strong></td>
                  </tr>
                  <tr>
                    <td>Phase A</td>
                    <td>{{ result.group1_load_balance_after.A }} kW</td>
                    <td>{{ result.group2_load_balance_after.A }} kW</td>
                  </tr>
                  <tr>
                    <td>Phase B</td>
                    <td>{{ result.group1_load_balance_after.B }} kW</td>
                    <td>{{ result.group2_load_balance_after.B }} kW</td>
                  </tr>
                  <tr>
                    <td>Phase C</td>
                    <td>{{ result.group1_load_balance_after.C }} kW</td>
                    <td>{{ result.group2_load_balance_after.C }} kW</td>
                  </tr>
                </tbody>
              </table>
            </div>
            </div>
          </div>
      </div>
      <div class="col-2">
        <!-- แทรก selector เอาข้อมูลจาก index มาให้เป็นตัวเลือก และเอาค่า lat lon ไปแสดงพิกัด ใน map จากข้อมูลในไฟล์ edge_diff.json -->
         <div class="card shadow-sm mb-3">
          <div class="card-header bg-light fw-bold">เลือกจุดแบ่งโหลด</div>
          <div class="card-body">
            <select id="splittingSelector" class="form-select mb-2">
              <option selected disabled>-- เลือก index --</option>
            </select>
            <div id="coordinateDisplay" class="small text-muted"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.29/"></script>
  <script>
    require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/GeoJSONLayer",
  "esri/Graphic",
  "esri/widgets/Legend"
], function(Map, MapView, GeoJSONLayer, Graphic, Legend) {

  const map = new Map({
    basemap: "streets-navigation-vector"
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [102.5, 16.0],
    zoom: 7
  });

  // const project = '{{ project }}'';

  // LV Lines
  const lvLineLayer = new GeoJSONLayer({
    url: "/output/{{project}}/lv_lines.geojson",
    title: "ระบบจำหน่าย 400/230 V",
    renderer: {
      type: "simple",
      symbol: {
        type: "simple-line",
        color: "#5fd918",
        width: 2,
        style: "dash"
      }
    },
    popupTemplate: {
      title: "LV Line",
      content: "คุณสมบัติ: {type}"
    }
  });

  // // MV Lines
  const mvLineLayer = new GeoJSONLayer({
    url: "/output/{{project}}/mv_lines.geojson",
    title: "ระบบจำหน่าย 22 kV",
    renderer: {
      type: "simple",
      symbol: {
        type: "simple-line",
        color: "#800000",
        width: 2,
        style: "dash-dot"
      }
    },
    popupTemplate: {
      title: "MV Line",
      content: "คุณสมบัติ: {type}"
    }
  });

  // Meters (Points)
  const meterLayer = new GeoJSONLayer({
    url: "/output/{{project}}/meter_groups.geojson",
    title: "กลุ่มของมิเตอร์",
    renderer: {
      type: "unique-value",        // หรือ simple ถ้าต้องการสีเดียว
      field: "group",               // แยกสีตามกลุ่ม ถ้ามี
      uniqueValueInfos: [
        {
          value: 1,
          symbol: {
            type: "simple-marker",
            color: "#2b73b3",
            size: 8,
            outline: { color: "white", width: 1 }
          },
          label: "Group 1"
        },
        {
          value: 2,
          symbol: {
            type: "simple-marker",
            color: "#d41571",
            size: 8,
            outline: { color: "white", width: 1 }
          },
          label: "Group 2"
        }
      ]
    },    
    labelingInfo: [
      {
        labelExpressionInfo: {
          expression: "$feature.voltage_text"
        },
        labelPlacement: "above-right",
        symbol: {
          type: "text",
          color: "black",
          font: {
            size: 10,
            family: "Arial"
          },
          haloColor: "white",
          haloSize: 1
        }
      }
    ],
    popupTemplate: {
      title: "Meter (Group {group})",
      content: "พิกัด: [{geometry.longitude}, {geometry.latitude}]"
    }
  });

  const featureGroups = new GeoJSONLayer({
    url: "/output/{{project}}/feature_groups.geojson",
    title: "หม้อแปลงและจุดแบ่งโหลด",
    renderer: {
      type: "unique-value",
      field: "group",
      uniqueValueInfos: [
        {
          value: "initial",
          label: "Initial Transformer",
          symbol: {
            type: "simple-marker",
            style: "square",
            color: "black",
            size: 10,
            outline: { color: "white", width: 1 }
          }
        },
        {
          value: "splitting",
          label: "Splitting Point",
          symbol: {
            type: "simple-marker",
            style: "diamond",
            color: "#be9d17",
            size: 12,
            outline: { color: "black", width: 1 }
          }
        },
        {
          value: "group1",
          label: "Group 1 Transformer",
          symbol: {
            type: "simple-marker",
            style: "diamond",
            color: "#2b73b3",
            size: 14,
            outline: { color: "white", width: 1 }
          }
        },
        {
          value: "group2",
          label: "Group 2 Transformer",
          symbol: {
            type: "simple-marker",
            style: "diamond",
            color: "#d41571",
            size: 14,
            outline: { color: "white", width: 1 }
          }
        }
      ]
    },
    labelingInfo: [
      {
        where: "group = 'initial'",
        labelExpressionInfo: { expression: "$feature.name" },
        labelPlacement: "above-right",
        symbol: {
          type: "text",
          color: "black",
          // haloColor: "white",
          // haloSize: 1,
          font: { size: 12, family: "Arial" }
        }
      },
      {
        where: "group = 'splitting'",
        labelExpressionInfo: { expression: "$feature.name" },
        labelPlacement: "above-right",
        symbol: {
          type: "text",
          color: "#be9d17",
          // haloColor: "black",
          // haloSize: 1,
          font: { size: 12, family: "Arial" }
        }
      },
      {
        where: "group = 'group1'",
        labelExpressionInfo: { expression: "$feature.name" },
        labelPlacement: "above-right",
        symbol: {
          type: "text",
          color: "#2b73b3",
          // haloColor: "white",
          // haloSize: 1,
          font: { size: 12, family: "Arial" }
        }
      },
      {
        where: "group = 'group2'",
        labelExpressionInfo: { expression: "$feature.name" },
        labelPlacement: "above-right",
        symbol: {
          type: "text",
          color: "#d41571",
          // haloColor: "white",
          // haloSize: 1,
          font: { size: 12, family: "Arial" }
        }
      }
    ],
    popupTemplate: {
      title: "{name}",
      content: "กลุ่ม: {group}<br>ตำแหน่ง: [{geometry.longitude}, {geometry.latitude}]"
    }
  });

  // map.add(featureGroups);

  
  meterLayer.when(() => {
    meterLayer.queryExtent().then((response) => {
      if (response.extent) {
        view.goTo(response.extent.expand(2.5));  // ขยายเล็กน้อยเพื่อให้มองเห็นทั้งหมด
      }
    });
  });

  map.addMany([ lvLineLayer, mvLineLayer, meterLayer, featureGroups ]);
  // map.addMany([ lvLineLayer, mvLineLayer, meterLayer]);
  const legend = new Legend({
    view: view,
    style: "classic"  // หรือ "classic" ตามที่ชอบ
  });
  view.ui.add(legend, "top-right");

  // โหลด edge_diffs.json
  fetch("/output/{{project}}/edge_diffs.json")
    .then(response => response.json())
    .then(data => {
      const selector = document.getElementById("splittingSelector");
      data.forEach((item, index) => {
        const opt = document.createElement("option");
        opt.value = index;
        opt.textContent = `Index ${item.splitting_index}`;
        selector.appendChild(opt);
      });

      let markerGraphic = null;

      selector.addEventListener("change", function () {
        const idx = parseInt(this.value);
        const selected = data[idx];

        const lat = selected.N1_Lat;
        const lon = selected.N1_Lon;

        // แสดงตำแหน่ง lat/lon
        document.getElementById("coordinateDisplay").innerText = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;

        // ลบ marker เดิมถ้ามี
        if (markerGraphic) view.graphics.remove(markerGraphic);

        // สร้าง marker ใหม่
        markerGraphic = new Graphic({
          geometry: {
            type: "point",
            longitude: lon,
            latitude: lat
          },
          symbol: {
            type: "simple-marker",
            style: "triangle",
            color: "red",
            size: "14px",
            angle: 180,  // หมุนหัวหมุดลงล่าง
            outline: {
              color: [255, 255, 255],
              width: 1
            }
          }
        });

        view.graphics.add(markerGraphic);
        view.goTo({ center: [lon, lat], zoom: 16 });
      });
    })
    .catch(err => console.error("โหลด edge_diffs.json ไม่สำเร็จ:", err));


});
  </script>
</body>

</html>
